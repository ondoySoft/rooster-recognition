{% extends "admin_base.html" %}

{% block title %}Upload Google Colab Model{% endblock %}

{% block content %}
<div id="module-messages"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Upload Google Colab Model</h4>
        <p class="text-muted mb-0">Upload your trained model from Google Colab</p>
    </div>
    <a href="{{ url_for('admin_models') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Models
    </a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Upload Model Files</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="model_name" class="form-label">Model Name *</label>
                        <input type="text" class="form-control" id="model_name" name="model_name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accuracy" class="form-label">Accuracy Score</label>
                        <input type="number" class="form-control" id="accuracy" name="accuracy" step="0.01" min="0" max="1" placeholder="0.95">
                    </div>
                    
                    <!-- ZIP Upload Option (Preferred) -->
                    <div class="mb-4">
                        <h6 class="text-primary">Option 1: ZIP File Upload (Recommended)</h6>
                        <div class="mb-3">
                            <label for="zip_file" class="form-label">SavedModel ZIP File</label>
                            <input type="file" class="form-control" id="zip_file" name="zip_file" accept=".zip">
                            <div class="form-text">Upload the complete ZIP file from Google Colab export</div>
                        </div>
                    </div>
                    
                    <!-- Individual Files Option -->
                    <div class="mb-4">
                        <h6 class="text-secondary">Option 2: Individual Files</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="model_file" class="form-label">Model File</label>
                                    <input type="file" class="form-control" id="model_file" name="model_file" accept=".h5,.keras">
                                    <div class="form-text">.h5 or .keras file</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mapping_file" class="form-label">Class Mapping</label>
                                    <input type="file" class="form-control" id="mapping_file" name="mapping_file" accept=".json">
                                    <div class="form-text">class_mapping.json</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i>Upload Model
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Instructions</h5>
            </div>
            <div class="card-body">
                <h6 class="text-primary">From Google Colab:</h6>
                <ol class="mb-3">
                    <li class="mb-2">
                        <strong>Export Model:</strong><br>
                        <small>Run the export cell to create SavedModel and class_mapping.json</small>
                    </li>
                    <li class="mb-2">
                        <strong>Download ZIP:</strong><br>
                        <small>Download the `saved_model.zip` file from Colab</small>
                    </li>
                    <li class="mb-0">
                        <strong>Upload Here:</strong><br>
                        <small>Upload the ZIP file using Option 1 above</small>
                    </li>
                </ol>
                
                <h6 class="text-secondary">Expected Structure:</h6>
                <div class="small text-muted">
                    <code>
                        saved_model.zip<br>
                        └── rooster_export/<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;├── saved_model/<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;├── assets/<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;├── variables/<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;├── fingerprint.pb<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;└── saved_model.pb<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;└── class_mapping.json
                    </code>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> The app will automatically extract and organize files in the correct structure.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Training History Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Google Colab Training History
                </h5>
            </div>
            <div class="card-body">
                <div id="colab-history-content">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p class="mb-0">Loading training history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const modelName = document.getElementById('model_name').value;
    const description = document.getElementById('description').value;
    const accuracy = document.getElementById('accuracy').value;
    
    if (!modelName.trim()) {
        showMessage('Model name is required', 'danger');
        return;
    }
    
    formData.append('model_name', modelName);
    formData.append('description', description);
    formData.append('accuracy', accuracy);
    
    // Check which upload method is being used
    const zipFile = document.getElementById('zip_file').files[0];
    const modelFile = document.getElementById('model_file').files[0];
    const mappingFile = document.getElementById('mapping_file').files[0];
    
    if (zipFile) {
        // ZIP upload
        formData.append('zip_file', zipFile);
    } else if (modelFile && mappingFile) {
        // Individual files upload
        formData.append('model_file', modelFile);
        formData.append('mapping_file', mappingFile);
    } else {
        showMessage('Please upload either a ZIP file or both model and mapping files', 'danger');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
    submitBtn.disabled = true;
    
    fetch('{{ url_for("admin_colab_upload") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message, 'success');
            document.getElementById('uploadForm').reset();
        } else {
            showMessage(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Upload failed: ' + error.message, 'danger');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function showMessage(message, type) {
    const messageContainer = document.getElementById('module-messages');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    messageContainer.innerHTML = '';
    messageContainer.appendChild(alertDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Load training history on page load
document.addEventListener('DOMContentLoaded', function() {
    loadColabHistory();
});

function loadColabHistory() {
    fetch('/admin/colab/history')
    .then(response => response.json())
    .then(data => {
        const historyContent = document.getElementById('colab-history-content');
        if (historyContent) {
            if (data.success && data.history.length > 0) {
                let historyHtml = '<div class="table-responsive">';
                historyHtml += '<table class="table table-sm table-hover">';
                historyHtml += '<thead class="table-light">';
                historyHtml += '<tr><th>Model Source</th><th>Status</th><th>Accuracy</th><th>Date</th></tr>';
                historyHtml += '</thead><tbody>';
                
                data.history.forEach(record => {
                    const statusClass = getStatusClass(record.status);
                    const accuracyText = record.accuracy_percentage || 'N/A';
                    const dateText = new Date(record.created_at).toLocaleDateString();
                    
                    historyHtml += `<tr>`;
                    historyHtml += `<td><small>${record.model_source || 'Unknown'}</small></td>`;
                    historyHtml += `<td><span class="badge ${statusClass}">${record.status}</span></td>`;
                    historyHtml += `<td><small>${accuracyText}</small></td>`;
                    historyHtml += `<td><small>${dateText}</small></td>`;
                    historyHtml += `</tr>`;
                });
                
                historyHtml += '</tbody></table></div>';
                historyContent.innerHTML = historyHtml;
            } else {
                historyContent.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p class="mb-0">No Google Colab models uploaded yet</p>
                    </div>
                `;
            }
        }
    })
    .catch(error => {
        console.error('Error loading Google Colab history:', error);
        const historyContent = document.getElementById('colab-history-content');
        if (historyContent) {
            historyContent.innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p class="mb-0">Error loading Google Colab history</p>
                </div>
            `;
        }
    });
}

function getStatusClass(status) {
    switch(status) {
        case 'completed': return 'bg-success';
        case 'accepted': return 'bg-primary';
        case 'rejected': return 'bg-danger';
        case 'failed': return 'bg-warning';
        case 'training': return 'bg-info';
        case 'pending': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}
</script>
{% endblock %}